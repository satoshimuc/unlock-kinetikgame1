<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Daily Neuro Training</title>
    <!-- Tailwind CSS for Modern UI -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- FontAwesome for Icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+JP:wght@400;700&display=swap" rel="stylesheet">
    
    <style>
        body {
            font-family: 'Noto Sans JP', sans-serif;
            background-color: #f0f4f8;
            touch-action: manipulation; /* Prevent double-tap zoom */
            user-select: none;
        }

        /* Custom Animations */
        @keyframes popIn {
            0% { transform: scale(0.9); opacity: 0; }
            100% { transform: scale(1); opacity: 1; }
        }
        
        @keyframes shake {
            0%, 100% { transform: translateX(0); }
            25% { transform: translateX(-5px); }
            75% { transform: translateX(5px); }
        }

        @keyframes pulse-green {
            0% { box-shadow: 0 0 0 0 rgba(74, 222, 128, 0.7); }
            70% { box-shadow: 0 0 0 10px rgba(74, 222, 128, 0); }
            100% { box-shadow: 0 0 0 0 rgba(74, 222, 128, 0); }
        }

        .animate-pop { animation: popIn 0.3s ease-out forwards; }
        .animate-shake { animation: shake 0.3s ease-in-out; }
        .animate-pulse-green { animation: pulse-green 0.5s; }

        .game-card {
            background: white;
            border-radius: 20px;
            box-shadow: 0 10px 25px -5px rgba(0, 0, 0, 0.1), 0 8px 10px -6px rgba(0, 0, 0, 0.1);
        }

        /* Hide scrollbar for clean UI */
        ::-webkit-scrollbar {
            display: none;
        }

        /* Button Press Effect */
        .btn-press:active {
            transform: scale(0.95);
        }
    </style>
</head>
<body class="h-screen w-full text-slate-700 flex flex-col items-center justify-center overflow-hidden relative">

    <!-- Background Elements -->
    <div class="absolute top-0 left-0 w-full h-full overflow-hidden -z-10">
        <div class="absolute top-[-10%] left-[-10%] w-64 h-64 bg-blue-200 rounded-full mix-blend-multiply filter blur-xl opacity-70 animate-blob"></div>
        <div class="absolute top-[-10%] right-[-10%] w-64 h-64 bg-purple-200 rounded-full mix-blend-multiply filter blur-xl opacity-70 animate-blob animation-delay-2000"></div>
        <div class="absolute bottom-[-20%] left-[20%] w-64 h-64 bg-pink-200 rounded-full mix-blend-multiply filter blur-xl opacity-70 animate-blob animation-delay-4000"></div>
    </div>

    <!-- MAIN APP CONTAINER -->
    <div id="app" class="w-full max-w-md h-full flex flex-col relative px-4 py-6">
        
        <!-- Header -->
        <header class="flex justify-between items-center mb-6">
            <div class="flex items-center gap-2">
                <i class="fa-solid fa-brain text-indigo-600 text-2xl"></i>
                <h1 class="text-xl font-bold tracking-tight text-slate-800">NeuroDaily</h1>
            </div>
            <div class="text-xs font-medium bg-white px-3 py-1 rounded-full shadow-sm text-slate-500">
                <span id="date-display">2023.01.01</span>
            </div>
        </header>

        <!-- VIEWS -->

        <!-- 1. LOADING VIEW -->
        <div id="view-loading" class="flex-1 flex flex-col justify-center items-center">
            <div class="animate-spin rounded-full h-12 w-12 border-b-2 border-indigo-600 mb-4"></div>
            <p class="text-sm text-slate-500">ãƒ‹ãƒ¥ãƒ¼ãƒ­ãƒ³æ¥ç¶šä¸­...</p>
        </div>

        <!-- 2. HOME VIEW (Start) -->
        <div id="view-home" class="hidden flex-1 flex flex-col justify-center items-center animate-pop">
            <div class="text-center mb-8">
                <div class="inline-block p-4 bg-indigo-100 rounded-full mb-4">
                    <i class="fa-solid fa-bolt text-indigo-600 text-4xl"></i>
                </div>
                <h2 class="text-2xl font-bold mb-2">ä»Šæ—¥ã®è„³ãƒˆãƒ¬</h2>
                <p class="text-slate-500 text-sm px-6">
                    ãƒ©ã‚¤ãƒ•ã‚­ãƒãƒ†ã‚£ãƒƒã‚¯ç†è«–ã«åŸºã¥ã<br>
                    1æ—¥1å›ã®çŸ­æœŸé›†ä¸­ãƒˆãƒ¬ãƒ¼ãƒ‹ãƒ³ã‚°ã€‚
                </p>
            </div>

            <div class="game-card w-full p-6 mb-8 border-l-4 border-indigo-500">
                <h3 id="daily-title" class="text-lg font-bold mb-1 text-indigo-900">Task Loading...</h3>
                <p id="daily-desc" class="text-sm text-slate-600 mb-4">...</p>
                <div class="flex items-center text-xs text-slate-400 gap-4">
                    <span><i class="fa-regular fa-clock mr-1"></i> 30ç§’</span>
                    <span><i class="fa-solid fa-trophy mr-1"></i> ã‚¹ã‚³ã‚¢ã‚¢ã‚¿ãƒƒã‚¯</span>
                </div>
            </div>

            <button onclick="app.startGame()" class="w-full bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-4 rounded-xl shadow-lg shadow-indigo-200 transition-all btn-press flex items-center justify-center gap-2">
                <i class="fa-solid fa-play"></i> ãƒˆãƒ¬ãƒ¼ãƒ‹ãƒ³ã‚°é–‹å§‹
            </button>
            <p class="text-xs text-center text-slate-400 mt-4">â€»éŸ³ã¯å‡ºã¾ã›ã‚“</p>
        </div>

        <!-- 3. GAME VIEW -->
        <div id="view-game" class="hidden flex-1 flex flex-col relative">
            <!-- Progress / Timer -->
            <div class="w-full bg-slate-200 rounded-full h-2 mb-6 overflow-hidden">
                <div id="timer-bar" class="bg-indigo-500 h-2 rounded-full transition-all duration-1000 ease-linear" style="width: 100%"></div>
            </div>

            <div class="flex justify-between items-end mb-4">
                <div class="text-sm font-bold text-slate-400">SCORE</div>
                <div id="score-display" class="text-4xl font-black text-slate-800">0</div>
            </div>

            <!-- Game Stage Area -->
            <div id="game-stage" class="flex-1 game-card flex flex-col justify-center items-center p-4 mb-6 relative overflow-hidden">
                <!-- Instruction Overlay (Fades out) -->
                <div id="instruction-overlay" class="absolute inset-0 bg-white/90 z-20 flex flex-col justify-center items-center text-center p-6">
                    <h3 class="text-xl font-bold mb-2 text-indigo-600">ãƒ«ãƒ¼ãƒ«</h3>
                    <p id="game-rule-text" class="font-bold text-slate-800 mb-6 text-lg">...</p>
                    <div class="text-3xl font-bold text-slate-300 animate-pulse">Ready...</div>
                </div>

                <!-- Main Stimulus -->
                <div id="stimulus-container" class="text-center z-10 w-full">
                    <!-- Dynamic Content injected by JS -->
                </div>
            </div>

            <!-- Controls Area -->
            <div id="controls-area" class="grid grid-cols-2 gap-4 h-32">
                <!-- Dynamic Buttons injected by JS -->
            </div>
        </div>

        <!-- 4. RESULT VIEW -->
        <div id="view-result" class="hidden flex-1 flex flex-col justify-center items-center animate-pop">
            <div class="text-center mb-8">
                <div class="text-6xl mb-2">ğŸ‰</div>
                <h2 class="text-2xl font-bold text-slate-800">Training Complete!</h2>
                <p class="text-sm text-slate-500">ãŠç–²ã‚Œæ§˜ã§ã—ãŸã€‚è„³ãŒæ´»æ€§åŒ–ã•ã‚Œã¾ã—ãŸã€‚</p>
            </div>

            <div class="game-card w-full p-8 text-center mb-8">
                <div class="text-sm text-slate-400 uppercase tracking-wider mb-2">Today's Score</div>
                <div id="final-score" class="text-6xl font-black text-indigo-600 mb-4">0</div>
                <div class="w-full border-t border-slate-100 my-4"></div>
                <p id="feedback-text" class="font-bold text-slate-700">ç´ æ™´ã‚‰ã—ã„é›†ä¸­åŠ›ã§ã™ï¼</p>
            </div>

            <button onclick="liff.closeWindow()" class="w-full bg-slate-800 text-white font-bold py-4 rounded-xl shadow-lg transition-all btn-press mb-3">
                é–‰ã˜ã‚‹
            </button>
            <p class="text-xs text-slate-400 text-center">ã¾ãŸæ˜æ—¥ãƒãƒ£ãƒ¬ãƒ³ã‚¸ã—ã¦ãã ã•ã„ã€‚</p>
        </div>

        <!-- 5. LIMIT REACHED VIEW -->
        <div id="view-limit" class="hidden flex-1 flex flex-col justify-center items-center animate-pop">
            <div class="w-24 h-24 bg-green-100 rounded-full flex items-center justify-center mb-6">
                <i class="fa-solid fa-check text-4xl text-green-500"></i>
            </div>
            <h2 class="text-2xl font-bold text-slate-800 mb-2">æœ¬æ—¥ã¯å®Œäº†æ¸ˆã¿ã§ã™</h2>
            <p class="text-slate-500 text-center mb-8 px-8">
                è„³ã®å®šç€ã®ãŸã‚ã«ä¼‘æ¯ã‚‚é‡è¦ã§ã™ã€‚<br>
                ã¾ãŸæ˜æ—¥ã€æ–°ã—ã„èª²é¡Œã§ãŠå¾…ã¡ã—ã¦ã„ã¾ã™ã€‚
            </p>
            <div class="text-xs bg-white p-4 rounded-lg shadow-sm text-slate-400 border border-slate-100">
                <i class="fa-solid fa-calendar-check mr-2"></i> æ¬¡å›: <span id="next-date">æ˜æ—¥</span>
            </div>
        </div>

    </div>

    <!-- LIFF SDK Loading -->
    <script charset="utf-8" src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>

    <!-- Main Application Script -->
    <script>
        /**
         * App State & Configuration
         */
        const AppConfig = {
            gameDuration: 30, // seconds
            storageKey: 'neuro_daily_last_played',
        };

        const GameData = [
            {
                id: 'stroop',
                title: 'è‰²å½©åˆ¤æ–­ã‚¹ã‚¤ãƒƒãƒ',
                desc: 'ã€Œæ–‡å­—ã®è‰²ã€ã¾ãŸã¯ã€Œæ–‡å­—ã®æ„å‘³ã€ã‚’ç¬æ™‚ã«åˆ¤æ–­ã—ã¦ãã ã•ã„ã€‚',
                rule: 'æŒ‡ç¤ºã«å¾“ã£ã¦ãƒœã‚¿ãƒ³ã‚’æŠ¼ã›ï¼',
                type: 'choice'
            },
            {
                id: 'direction',
                title: 'ç©ºé–“åè»¢ãƒŠãƒ“',
                desc: 'çŸ¢å°ã®å‘ãã¨é€†ã€ã¾ãŸã¯åŒã˜æ–¹å‘ã‚’æŒ‡ç¤ºé€šã‚Šã«å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚',
                rule: 'ã€Œé€†ã€ãªã‚‰åå¯¾ã€ã€Œæ­£ã€ãªã‚‰ãã®ã¾ã¾ï¼',
                type: 'choice'
            },
            {
                id: 'math_reflex',
                title: 'å¶æ•°ãƒ»å¥‡æ•°ã‚½ãƒ¼ã‚¿ãƒ¼',
                desc: 'è¡¨ç¤ºã•ã‚Œã‚‹æ•°å­—ãŒå¶æ•°ã‹å¥‡æ•°ã‹ã‚’ç¬æ™‚ã«ä»•åˆ†ã‘ã¦ãã ã•ã„ã€‚',
                rule: 'å¶æ•°ã‹å¥‡æ•°ã‹åˆ¤æ–­ã›ã‚ˆï¼',
                type: 'choice'
            }
        ];

        const app = {
            state: {
                currentView: 'loading',
                score: 0,
                timeLeft: AppConfig.gameDuration,
                isPlaying: false,
                todayGameIndex: 0,
                timerInterval: null,
                currentQuestion: null
            },

            // --- Initialization ---
            init: async function() {
                this.updateDateDisplay();
                
                // Determine today's game based on date hash
                const today = new Date();
                // Simple hash: Sum of year+month+date % game count
                const dateHash = today.getFullYear() + today.getMonth() + today.getDate();
                this.state.todayGameIndex = dateHash % GameData.length;

                // Check LocalStorage for daily limit
                const lastPlayed = localStorage.getItem(AppConfig.storageKey);
                const todayStr = today.toDateString();

                if (lastPlayed === todayStr) {
                    this.switchView('limit');
                } else {
                    this.setupHome();
                    this.switchView('home');
                }
            },

            updateDateDisplay: function() {
                const now = new Date();
                const options = { year: 'numeric', month: '2-digit', day: '2-digit', weekday: 'short' };
                document.getElementById('date-display').innerText = now.toLocaleDateString('ja-JP', options);
                
                const tomorrow = new Date(now);
                tomorrow.setDate(tomorrow.getDate() + 1);
                document.getElementById('next-date').innerText = tomorrow.toLocaleDateString('ja-JP', {month: '2-digit', day: '2-digit'});
            },

            setupHome: function() {
                const game = GameData[this.state.todayGameIndex];
                document.getElementById('daily-title').innerText = game.title;
                document.getElementById('daily-desc').innerText = game.desc;
                document.getElementById('game-rule-text').innerText = game.rule;
            },

            // --- View Management ---
            switchView: function(viewName) {
                ['loading', 'home', 'game', 'result', 'limit'].forEach(v => {
                    const el = document.getElementById(`view-${v}`);
                    if (v === viewName) {
                        el.classList.remove('hidden');
                        if(v !== 'loading') el.classList.add('flex');
                    } else {
                        el.classList.add('hidden');
                        el.classList.remove('flex');
                    }
                });
                this.state.currentView = viewName;
            },

            // --- Game Logic ---
            startGame: function() {
                this.switchView('game');
                this.state.score = 0;
                this.state.timeLeft = AppConfig.gameDuration;
                this.updateScoreUI();
                
                // Show instruction overlay for 2 seconds then start
                const overlay = document.getElementById('instruction-overlay');
                overlay.style.display = 'flex';
                
                setTimeout(() => {
                    overlay.style.display = 'none';
                    this.state.isPlaying = true;
                    this.startTimer();
                    this.nextRound();
                }, 2000);
            },

            startTimer: function() {
                const timerBar = document.getElementById('timer-bar');
                timerBar.style.width = '100%';
                
                this.state.timerInterval = setInterval(() => {
                    this.state.timeLeft--;
                    const pct = (this.state.timeLeft / AppConfig.gameDuration) * 100;
                    timerBar.style.width = `${pct}%`;
                    
                    if (this.state.timeLeft <= 10) {
                        timerBar.classList.remove('bg-indigo-500');
                        timerBar.classList.add('bg-red-500');
                    }

                    if (this.state.timeLeft <= 0) {
                        this.endGame();
                    }
                }, 1000);
            },

            nextRound: function() {
                if (!this.state.isPlaying) return;
                
                const gameType = GameData[this.state.todayGameIndex].id;
                const stage = document.getElementById('stimulus-container');
                const controls = document.getElementById('controls-area');
                
                // Clear previous
                stage.innerHTML = '';
                controls.innerHTML = '';

                let question = {};

                // --- LOGIC FOR DIFFERENT GAMES ---
                
                // Game 1: Stroop (Color vs Text)
                if (gameType === 'stroop') {
                    const colors = [
                        { name: 'ã‚ã‹', code: 'text-red-500', bg: 'bg-red-100', val: 'red' },
                        { name: 'ã‚ãŠ', code: 'text-blue-500', bg: 'bg-blue-100', val: 'blue' },
                        { name: 'ã¿ã©ã‚Š', code: 'text-green-500', bg: 'bg-green-100', val: 'green' },
                        { name: 'ãã„ã‚', code: 'text-yellow-500', bg: 'bg-yellow-100', val: 'yellow' }
                    ];
                    
                    // Decide rule: Answer Color or Answer Text?
                    const mode = Math.random() > 0.5 ? 'color' : 'text';
                    const targetText = colors[Math.floor(Math.random() * colors.length)];
                    const targetColor = colors[Math.floor(Math.random() * colors.length)]; // Can be conflicting
                    
                    const correctAnswer = mode === 'color' ? targetColor.val : targetText.val;
                    
                    // Render Stimulus
                    stage.innerHTML = `
                        <div class="text-sm font-bold text-slate-400 mb-2 uppercase tracking-widest">
                            ${mode === 'color' ? 'æ–‡å­—ã®è‰²ã¯ï¼Ÿ' : 'æ–‡å­—ã®èª­ã¿ã¯ï¼Ÿ'}
                        </div>
                        <div class="text-6xl font-black ${targetColor.code} transition-all transform scale-100">
                            ${targetText.name}
                        </div>
                    `;

                    // Render Buttons (Shuffle options)
                    const options = [...colors].sort(() => Math.random() - 0.5);
                    options.forEach(opt => {
                        const btn = document.createElement('button');
                        btn.className = `${opt.bg} ${opt.code} font-bold rounded-xl text-lg shadow-sm active:scale-95 transition-transform flex items-center justify-center`;
                        btn.innerText = opt.name;
                        btn.onclick = () => this.handleAnswer(opt.val === correctAnswer);
                        controls.appendChild(btn);
                    });
                }

                // Game 2: Direction (Reverse Logic)
                else if (gameType === 'direction') {
                    const dirs = ['up', 'down', 'left', 'right'];
                    const icons = { up: 'fa-arrow-up', down: 'fa-arrow-down', left: 'fa-arrow-left', right: 'fa-arrow-right' };
                    const jp = { up: 'ä¸Š', down: 'ä¸‹', left: 'å·¦', right: 'å³' };
                    
                    const actualDir = dirs[Math.floor(Math.random() * dirs.length)];
                    const isReverse = Math.random() > 0.5;
                    
                    // Calculate correct answer
                    let correctDir = actualDir;
                    if (isReverse) {
                        if (actualDir === 'up') correctDir = 'down';
                        if (actualDir === 'down') correctDir = 'up';
                        if (actualDir === 'left') correctDir = 'right';
                        if (actualDir === 'right') correctDir = 'left';
                    }

                    stage.innerHTML = `
                        <div class="text-sm font-bold ${isReverse ? 'text-red-500' : 'text-blue-500'} mb-4 uppercase tracking-widest">
                            ${isReverse ? 'â˜… é€†ã‚’å‘ã‘ â˜…' : 'ãã®ã¾ã¾å‘ã‘'}
                        </div>
                        <div class="text-8xl text-slate-800">
                            <i class="fa-solid ${icons[actualDir]}"></i>
                        </div>
                    `;

                    dirs.forEach(d => {
                        const btn = document.createElement('button');
                        btn.className = `bg-white border-2 border-slate-200 text-slate-600 font-bold rounded-xl text-2xl shadow-sm active:scale-95 transition-transform flex items-center justify-center`;
                        btn.innerHTML = `<i class="fa-solid ${icons[d]}"></i>`;
                        btn.onclick = () => this.handleAnswer(d === correctDir);
                        controls.appendChild(btn);
                    });
                }

                // Game 3: Math Reflex (Even/Odd)
                else if (gameType === 'math_reflex') {
                    const num = Math.floor(Math.random() * 99) + 1;
                    const isEven = num % 2 === 0;
                    
                    stage.innerHTML = `
                        <div class="text-sm font-bold text-slate-400 mb-4">æ•°å­—ã¯ã©ã£ã¡ï¼Ÿ</div>
                        <div class="text-8xl font-black text-indigo-600 font-mono">
                            ${num}
                        </div>
                    `;

                    // Buttons
                    const btnEven = document.createElement('button');
                    btnEven.className = `bg-indigo-100 text-indigo-700 font-bold rounded-xl text-xl shadow-sm active:scale-95 py-4`;
                    btnEven.innerText = "å¶æ•° (2,4,6...)";
                    btnEven.onclick = () => this.handleAnswer(isEven);

                    const btnOdd = document.createElement('button');
                    btnOdd.className = `bg-orange-100 text-orange-700 font-bold rounded-xl text-xl shadow-sm active:scale-95 py-4`;
                    btnOdd.innerText = "å¥‡æ•° (1,3,5...)";
                    btnOdd.onclick = () => this.handleAnswer(!isEven);

                    controls.appendChild(btnEven);
                    controls.appendChild(btnOdd);
                }
            },

            handleAnswer: function(isCorrect) {
                if (!this.state.isPlaying) return;

                const stage = document.getElementById('game-stage');

                if (isCorrect) {
                    this.state.score += 10;
                    // Visual feedback
                    stage.classList.add('animate-pulse-green');
                    setTimeout(() => stage.classList.remove('animate-pulse-green'), 500);
                } else {
                    // Penalty? Or just shake
                    stage.classList.add('animate-shake');
                    setTimeout(() => stage.classList.remove('animate-shake'), 300);
                    // Optional: Time penalty
                    // this.state.timeLeft = Math.max(0, this.state.timeLeft - 2); 
                }
                
                this.updateScoreUI();
                this.nextRound();
            },

            updateScoreUI: function() {
                document.getElementById('score-display').innerText = this.state.score;
            },

            endGame: function() {
                this.state.isPlaying = false;
                clearInterval(this.state.timerInterval);
                
                // Save Played Status
                const todayStr = new Date().toDateString();
                localStorage.setItem(AppConfig.storageKey, todayStr);

                // Show Result
                document.getElementById('final-score').innerText = this.state.score;
                
                let feedback = "";
                if (this.state.score > 250) feedback = "ç¥ãƒ¬ãƒ™ãƒ«ã®è„³å‡¦ç†é€Ÿåº¦ã§ã™ï¼";
                else if (this.state.score > 150) feedback = "ç´ æ™´ã‚‰ã—ã„ï¼è„³ãŒè‹¥è¿”ã£ã¦ã„ã¾ã™ã€‚";
                else if (this.state.score > 50) feedback = "ãƒŠã‚¤ã‚¹ãƒ•ã‚¡ã‚¤ãƒˆï¼ç¶™ç¶šãŒåŠ›ãªã‚Šã€‚";
                else feedback = "ãƒ‰ãƒ³ãƒã‚¤ï¼æ˜æ—¥ã¯ã‚‚ã£ã¨ã„ã‘ã¾ã™ã€‚";
                
                document.getElementById('feedback-text').innerText = feedback;
                
                this.switchView('result');
            }
        };

        // --- LIFF & Boot Logic ---
        
        window.onload = function() {
            // Placeholder logic to prevent crash if LIFF ID is invalid in preview
            const liffId = "LIFF_ID_PLACEHOLDER"; 

            // Initialize App Logic first (Visuals)
            
            // Initialize LIFF
            if (typeof liff !== 'undefined') {
                liff.init({ liffId: liffId })
                    .then(() => {
                        console.log("LIFF initialized");
                        if (!liff.isLoggedIn() && liff.isInClient()) {
                            liff.login();
                        }
                    })
                    .catch((err) => {
                        console.warn("LIFF Init failed (Expected in preview mode):", err);
                        // Continue anyway for web preview
                    })
                    .finally(() => {
                        // Start App after init attempt
                        setTimeout(() => app.init(), 500);
                    });
            } else {
                console.error("LIFF SDK not found");
                app.init();
            }
        };

    </script>
</body>
</html>
